<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">

<title>A Castle in the Cloud</title>

<script type="text/javascript">
// Frame buster
if(top !== self) {
  top.location.replace(self.location.href);
}
</script>

<script type="text/javascript" src="draggabilly.pkgd.min.js"></script>
<script type="text/javascript" src="EventEmitter.min.js"></script>
<script type="text/javascript" src="panelui.js"></script>
<script type="text/javascript" src="three.min.js"></script>
<script type="text/javascript" src="three.Densaugeo.js"></script>
<script type="text/javascript" src="castleMap.js"></script>

<link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="panelui_light.css" id="light_colors">
<link rel="stylesheet" href="panelui_dark.css" id="dark_colors">
<link rel="stylesheet" href="panelui.css">

<style type="text/css">
canvas {
  position: absolute;
  top:      0;
  bottom:   0;
  left:     48px;
  right:    0;
  z-index: -1;
  padding:  0;
  border:   none;
  margin:   0;
}

#help {
  top: 12px;
  left: 60px;
}
</style>
</head>

<body>
<a title="Real Time Web Analytics" style="visibility:hidden" href="http://clicky.com/100755588"><img alt="Real Time Web Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a>
<script type="text/javascript">
var clicky_site_ids = clicky_site_ids || [];
clicky_site_ids.push(100755588);
(function() {
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = '//static.getclicky.com/js';
  ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
})();
</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100755588ns.gif" /></p></noscript>

</body>

<script type="text/javascript">

////////
// UI //
////////

var sidebar = new PanelUI.Sidebar();

sidebar.addButton({buttonName: 'land', faClass: 'fa-university', title: 'Landing page'});
sidebar.on('land', function(e) {
  document.location.href = document.location.origin + '/index.html';
});

sidebar.addButton({buttonName: 'help', faClass: 'fa-question', title: 'Help'});
sidebar.on('help', function(e) {
  helpPanel.isOpen() ? helpPanel.close() : helpPanel.open();
});

var grids = new THREE.Densaugeo.CoordinateMaterial();
var trippyGridShader = new THREE.Densaugeo.CoordinateMaterial({side: THREE.DoubleSide, local: true, showAxes: new THREE.Vector3(0, 0, 0)});
var ghosty = new THREE.Densaugeo.PositionMaterial({transparent: true, alpha: 0.8});
var normalses = new THREE.Densaugeo.NormalMaterial();
var weedShader = new THREE.Densaugeo.PsychMaterial();

var specialShaders = [grids, trippyGridShader, ghosty, normalses, weedShader];

var changeMaterials = function(object) {
  if(object instanceof THREE.Mesh) {
    switch(specialShaders.indexOf(object.material)) {
      case -1:
        object.originalMaterial = object.material;
        object.material = specialShaders[0];
        break;
      case specialShaders.length - 1:
        object.material = object.originalMaterial;
        break;
      default:
        object.material = specialShaders[specialShaders.indexOf(object.material) + 1];
    }
  }
  
  if(object instanceof THREE.Object3D) {
    for(var i = 0, endi = object.children.length; i < endi; ++i) {
      changeMaterials(object.children[i]);
    }
  }
}

sidebar.addButton({buttonName: 'shader', faClass: 'fa-eye', repeatable: true, title: 'Trippy shader'});
sidebar.on('shader', function(e) {
  changeMaterials(scene);
});

if(HTMLElement.prototype.requestFullscreen == null) {
  HTMLElement.prototype.requestFullscreen = HTMLElement.prototype.msRequestFullscreen || HTMLElement.prototype.mozRequestFullScreen || HTMLElement.prototype.webkitRequestFullscreen;
}
if(document.exitFullscreen == null) {
  document.exitFullscreen = document.msExitFullscreen || document.mozCancelFullScreen || document.webkitExitFullscreen;
}
var getFullscreenElement = function() {
  return document.fullscreenElement || document.msFullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement;
}

sidebar.addButton({buttonName: 'fs', faClass: 'fa-arrows-alt', title: 'Fullscreen'});
sidebar.on('fs', function(e) {
  if(getFullscreenElement() == null) {
    document.body.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
});

var darkColors = document.getElementById('dark_colors');
var head = darkColors.parentNode;
var contrastFlipped = false;

if(localStorage.contrast === 'light') {
  head.removeChild(darkColors);
}

sidebar.addButton({buttonName: 'contrast', faClass: 'fa-adjust', title: 'Flip Contrast'});
sidebar.on('contrast', function(e) {
  if(contrastFlipped = !contrastFlipped) {
    head.removeChild(darkColors);
    localStorage.contrast = 'light';
  } else {
    head.appendChild(darkColors);
    localStorage.contrast = 'dark';
  }
});

sidebar.addButton({buttonName: 'clear', faClass: 'fa-recycle', title: 'Clear local storage'});
sidebar.on('clear', function(e) {
  localStorage.clear();
});

var helpPanel = new PanelUI.Panel({id: 'help', heading: 'Controls:', startOpen: false});
helpPanel.domElement.appendChild(fE('div', {}, [
  fE('text', {textContent: 'Touchscreen:'}),
  fE('br'),
  fE('text', {textContent: 'First finger drag - Pan'}),
  fE('br'),
  fE('text', {textContent: 'Second finger drag - Rotate'}),
  fE('br'),
  fE('text', {textContent: 'Slide along right edge - Throttle'}),
  fE('br'),
  fE('br'),
  fE('text', {textContent: 'Mouse:'}),
  fE('br'),
  fE('text', {textContent: 'Left click and drag - Pan'}),
  fE('br'),
  fE('text', {textContent: 'Right click and drag - Rotate'}),
  fE('br'),
  fE('text', {textContent: 'Scroll wheel - Dolly'}),
  fE('br'),
  fE('text', {textContent: 'Shift click - Activate mouse look'}),
  fE('br'),
  fE('text', {textContent: 'Esc - Exit mouse look'}),
  fE('br'),
  fE('br'),
  fE('text', {textContent: 'Keyboard:'}),
  fE('br'),
  fE('text', {textContent: 'W/S - Fly forward/backward'}),
  fE('br'),
  fE('text', {textContent: 'A/D - Strafe left/right'}),
  fE('br'),
  fE('text', {textContent: 'E/C - Ascend/Descend'}),
  fE('br'),
  fE('text', {textContent: 'Arrows - Turn'}),
  fE('br'),
  fE('br'),
  fE('text', {textContent: 'Gamepad (press any face button to activate):'}),
  fE('br'),
  fE('text', {textContent: 'Left stick - Pan'}),
  fE('br'),
  fE('text', {textContent: 'Right stick - Turn'}),
  fE('br'),
  fE('text', {textContent: 'Left/right trigger - Throttle back/forward'}),
]));

/////////////////
// THREE setup //
/////////////////

var scene = new THREE.Scene();

var camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 48)/window.innerHeight, 1, 1000);
camera.matrix.set(
  0.8583453893661499, -0.2562495470046997, 0.4444985091686249, 28.422760009765625,
  0.5130719542503357, 0.4286935329437256, -0.7436251044273376, -49.2386474609375,
  0, 0.8663473129272461, 0.49944186210632324, 27.35080909729004,
  0, 0, 0, 1
);

scene.add(camera);

var ambientLight = new THREE.AmbientLight(0x7F7F7F);
scene.add(ambientLight);

var directionalLight = new THREE.DirectionalLight(0x808080);
directionalLight.position.set(-7.1, 2.75, 10);
scene.add(directionalLight);

var loader = new THREE.Densaugeo.JSONMultiLoader();

var renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth - 48, window.innerHeight);
renderer.setClearColor(0xC0C0C0, 1);

document.body.appendChild(renderer.domElement);

var controls = new THREE.Densaugeo.FreeControls(camera, renderer.domElement, {panMouseSpeed: 0.05, dollySpeed: 5});

// WebGL occupies entire browser window
window.addEventListener("resize", function() {
  camera.aspect = (window.innerWidth - 48)/window.innerHeight;
  camera.updateProjectionMatrix();
  
  renderer.setSize(window.innerWidth - 48, window.innerHeight);
});

// Put stuff in scene
scene.add(castleMap.castle);

castleMap.load();

//scene.add(f3D(THREE.Mesh, {geometry: new THREE.PlaneGeometry(128, 128, 1, 1), material: waterShader, position: [0, 0, -0.5]}));
scene.add(water = f3D(THREE.Mesh, {geometry: new THREE.PlaneGeometry(128, 128, 1, 1), material: new THREE.Densaugeo.WaterMaterial({side: THREE.DoubleSide}), position: [0, 0, -0.5]}));

/////////////////////////
// Tick initialization //
/////////////////////////

var timePrevious = Date.now(), timeDelta = 0;

function tick() {
  timeDelta = -timePrevious + (timePrevious = Date.now());
  
  // Also updates scene-wide shader materials, because they are applied to the water mesh too
  if(water.material.tick) water.material.tick(timeDelta/1000);
  
  renderer.render(scene, camera);
  
  requestAnimationFrame(tick);
}

tick();

// Startup scripts //

eval(localStorage.onstart);

</script>
</html>
